# MCP 管理平台产品需求文档 (PRD)

## 项目概述

MCP（Model-Controller-Provider）管理平台是一个用于管理和调用各种 MCP 服务的 Web 应用程序。该应用程序允许用户创建会话、连接 MCP 服务、进行 AI 聊天交互，以及测试函数调用功能。应用采用模块化设计，包括会话管理、MCP 管理、聊天功能、函数测试等多个核心模块。

## 领域划分

根据领域驱动设计(DDD)方法论，我们将应用功能划分为以下几个领域：

1. 会话领域（Session Domain）
2. MCP 管理领域（MCP Management Domain）
3. 聊天领域（Chat Domain）
4. 工具调用领域（Tool Invocation Domain）
5. 配置管理领域（Configuration Domain）
6. 界面交互领域（UI Interaction Domain）
7. MCP 服务池领域（MCP Pool Domain）

## 1. 会话领域（Session Domain）

### 1.1 会话创建功能

**功能名称**: 会话创建

**业务价值**: 为用户提供一个唯一标识的会话环境，使所有后续操作都在该会话上下文中进行

**用户故事**: 作为用户，我希望能够创建一个新的会话，以便开始使用 MCP 服务

**功能需求**:

- 系统应提供"创建新会话"按钮
- 用户点击按钮后，前端向后端 API 发送创建会话请求
- 请求应包含随机生成的用户 ID
- 创建成功后，应返回唯一的会话 ID
- 会话 ID 应保存在本地存储中，以便下次访问时恢复
- 创建会话过程中，应显示加载状态并禁用相关 UI 元素
- 创建成功后，应向用户显示成功消息

**技术实现**:

- 使用 POST 请求调用`/api/session`接口
- 成功后将会话 ID 存储在 localStorage 中
- 使用事件总线发出会话变更通知
- 创建会话后自动连接 WebSocket

**验收标准**:

- 用户能成功创建新会话并获得会话 ID
- 会话 ID 正确显示在界面上
- 创建后自动连接 WebSocket
- 操作过程中有适当的 UI 反馈
- 出现错误时显示友好的错误提示

### 1.2 会话恢复功能

**功能名称**: 会话恢复

**业务价值**: 允许用户在重新打开应用时恢复之前的会话，保持连续性体验

**用户故事**: 作为用户，我希望在再次打开应用时能够自动恢复我上次的会话状态

**功能需求**:

- 应用启动时自动检查本地存储中是否有会话 ID
- 如果存在，验证该会话是否仍然有效
- 如果会话有效，恢复该会话及其关联的 MCP 列表
- 如果会话无效，创建新会话
- 恢复过程应向用户提供视觉反馈

**技术实现**:

- 从 localStorage 中检索`mcpSessionId`
- 使用 GET 请求调用`/api/mcp?sessionId={sessionId}`验证会话
- 成功后更新会话显示、连接 WebSocket、加载 MCP 列表
- 失败后创建新会话

**验收标准**:

- 有效会话能够成功恢复
- 无效会话会自动创建新会话
- 恢复的会话能正确加载关联的 MCP 列表
- 会话恢复过程流畅，有良好的用户体验
- 出现问题时给予用户适当反馈

## 2. MCP 管理领域（MCP Management Domain）

### 2.1 MCP 列表查看功能

**功能名称**: MCP 列表查看

**业务价值**: 让用户了解当前会话中所有可用的 MCP 服务，便于管理和使用

**用户故事**: 作为用户，我希望能查看当前会话中所有已连接的 MCP 服务及其状态

**功能需求**:

- 提供 MCP 列表标签页显示所有已连接的 MCP
- 列表应显示每个 MCP 的名称、类型和连接状态
- 对于每个 MCP，显示其提供的工具列表
- 当 MCP 列表为空时，显示引导用户添加 MCP 的提示
- 列表应实时更新反映 MCP 的最新状态

**技术实现**:

- 通过 GET 请求调用`/api/mcp?sessionId={sessionId}`获取 MCP 列表
- 使用模板和 DOM 操作渲染 MCP 列表
- 通过 WebSocket 监听 MCP 状态变化
- 使用事件总线通知 UI 更新

**验收标准**:

- 列表正确显示所有 MCP 及其状态
- 状态变化时列表会实时更新
- 每个 MCP 的工具正确显示
- 空列表状态有友好的用户引导
- 显示 MCP 总数

### 2.2 添加 MCP 功能

**功能名称**: 添加 MCP

**业务价值**: 允许用户扩展系统功能，连接到特定的 MCP 服务以获取新能力

**用户故事**: 作为用户，我希望能够添加新的 MCP 服务到当前会话

**功能需求**:

- 提供添加 MCP 的表单界面
- 支持两种 MCP 类型：stdio 和 http
- 对于 stdio 类型，需要输入命令、参数和环境变量
- 对于 http 类型，需要输入 URL
- 表单应进行输入验证，确保必要字段已填写
- 添加过程显示加载状态
- 添加成功后自动返回列表视图

**技术实现**:

- 通过 POST 请求调用`/api/mcp`接口添加 MCP
- 针对不同类型提供相应的表单字段
- 表单验证确保数据完整性
- 成功后更新 MCP 列表并通知相关组件

**验收标准**:

- 用户能成功添加 stdio 类型的 MCP
- 用户能成功添加 http 类型的 MCP
- 表单验证正常工作，防止提交不完整数据
- 添加过程有良好的 UI 反馈
- 添加成功后自动切换到列表视图

### 2.3 MCP 重连功能

**功能名称**: MCP 重连

**业务价值**: 允许用户在 MCP 连接断开后，不必重新配置即可恢复连接

**用户故事**: 作为用户，我希望能够简单地重新连接已断开的 MCP 服务

**功能需求**:

- 在 MCP 列表中为每个服务提供重连按钮
- 重连过程应显示加载状态
- 重连成功后更新 MCP 状态
- 重连失败时提供错误反馈

**技术实现**:

- 重用原 MCP 配置信息发送添加请求
- 根据 MCP 类型准备不同的载荷
- 成功后更新列表并触发事件

**验收标准**:

- 用户能通过点击重连按钮重新连接 MCP
- 重连过程有加载状态提示
- 重连成功后状态正确更新
- 重连失败时显示友好的错误提示

### 2.4 删除 MCP 功能

**功能名称**: 删除 MCP

**业务价值**: 允许用户移除不再需要的 MCP 服务，保持会话整洁

**用户故事**: 作为用户，我希望能够删除不需要的 MCP 服务

**功能需求**:

- 在 MCP 列表中为每个服务提供删除按钮
- 删除前应显示确认提示（可选）
- 删除过程显示加载状态
- 删除成功后更新列表

**技术实现**:

- 通过 DELETE 请求调用`/api/mcp`接口
- 成功后从列表中移除相应 MCP
- 通过事件总线通知相关组件

**验收标准**:

- 用户能成功删除 MCP 服务
- 删除过程有适当的 UI 反馈
- 删除后列表正确更新
- 删除失败时显示友好的错误提示

### 2.5 MCP 预设管理功能

**功能名称**: MCP 预设管理

**业务价值**: 提供常用 MCP 的快速配置，简化用户添加流程

**用户故事**: 作为用户，我希望能够从预定义的列表中选择常用 MCP 快速添加

**功能需求**:

- 提供常用 MCP 预设下拉选择器
- 包含常用服务如 OpenAI、Stripe、高德地图等
- 选择后自动填充相应的配置到表单
- 让用户可以修改预填充的值后再添加

**技术实现**:

- 维护预设配置对象`MCP_PRESETS`
- 监听预设选择器的 change 事件
- 选择后自动填充表单并切换到相应类型

**验收标准**:

- 用户能从下拉列表选择预设 MCP
- 选择后表单正确填充配置信息
- 所有预设项都能正常工作
- 用户可以修改预填充值后添加

## 3. 聊天领域（Chat Domain）

### 3.1 发送消息功能

**功能名称**: 发送消息

**业务价值**: 允许用户与 AI 助手进行交互，提问并获取答案

**用户故事**: 作为用户，我希望能向 AI 发送消息并得到回复

**功能需求**:

- 提供消息输入框和发送按钮
- 支持按 Enter 键发送消息
- 消息发送前验证会话和 MCP 连接状态
- 发送过程中显示加载状态
- 消息和回复应以对话形式显示
- 支持显示代码块等格式化内容

**技术实现**:

- 通过 POST 请求调用`/api/chat`接口
- 在发送过程中禁用输入和按钮
- 使用模板渲染消息和回复
- 支持基本 Markdown 格式解析

**验收标准**:

- 用户能发送消息并收到 AI 回复
- 消息发送过程有加载状态提示
- 消息和回复正确显示在聊天界面
- 代码块等格式化内容正确渲染
- 出错时提供友好的错误提示

### 3.2 聊天历史管理功能

**功能名称**: 聊天历史管理

**业务价值**: 保持会话连续性，允许用户查看和管理过去的对话

**用户故事**: 作为用户，我希望能查看聊天历史并在需要时清除历史

**功能需求**:

- 会话恢复时自动加载聊天历史
- 提供清除聊天历史的按钮
- 按时间顺序显示历史消息
- 支持查看历史消息中的函数调用

**技术实现**:

- 通过 GET 请求调用`/api/chat/history/{sessionId}`获取历史
- 通过 DELETE 请求清除历史
- 使用模板渲染历史消息

**验收标准**:

- 会话恢复时正确加载并显示历史消息
- 用户能成功清除聊天历史
- 历史消息按正确顺序显示
- 操作过程中有适当的 UI 反馈

## 4. 工具调用领域（Tool Invocation Domain）

### 4.1 函数调用测试功能

**功能名称**: 函数调用测试

**业务价值**: 允许开发者测试 MCP 提供的函数，验证其工作正常

**用户故事**: 作为开发者，我希望能测试 AI 通过 MCP 调用函数的能力

**功能需求**:

- 提供函数测试专用输入框和运行按钮
- 显示测试结果，包括 AI 响应和函数调用详情
- 支持查看函数参数和返回结果
- 提供清除结果按钮

**技术实现**:

- 通过 POST 请求调用`/api/test/function-call`接口
- 解析和格式化显示函数调用和结果
- 支持文本响应和函数调用两种结果展示

**验收标准**:

- 用户能发送测试消息并看到 AI 响应
- 函数调用详情正确显示
- 参数和结果格式正确
- 清除功能正常工作
- 测试过程有良好的 UI 反馈

### 4.2 MCP 工具调用功能

**功能名称**: MCP 工具调用

**业务价值**: 允许用户直接调用 MCP 提供的工具，无需通过 AI 中介

**用户故事**: 作为用户，我希望能直接调用 MCP 提供的各种工具

**功能需求**:

- 在 MCP 列表中显示每个 MCP 提供的工具
- 点击工具按钮打开交互对话框
- 根据工具类型提供相应的参数输入界面
- 执行工具并显示结果
- 支持特定工具的专用界面（搜索、计算器、天气等）

**技术实现**:

- 通过 POST 请求调用`/api/mcp/call`接口
- 动态创建工具对话框
- 根据工具类型提供专用输入界面
- 格式化显示调用结果

**验收标准**:

- 用户能查看 MCP 提供的工具列表
- 点击工具按钮打开对应对话框
- 能输入参数并执行工具
- 结果正确显示
- 错误处理得当

## 5. 配置管理领域（Configuration Domain）

### 5.1 配置导入功能

**功能名称**: 配置导入

**业务价值**: 允许用户通过配置文件批量添加 MCP，提高效率

**用户故事**: 作为用户，我希望能够导入预先准备好的配置文件来批量添加 MCP

**功能需求**:

- 提供配置文件上传界面
- 支持 JSON 格式的配置文件
- 解析配置并批量添加 MCP
- 显示导入进度和结果

**技术实现**:

- 使用 FileReader 读取上传文件
- 解析 JSON 配置格式
- 批量调用 MCP 添加接口
- 使用 Promise.all 处理并行请求

**验收标准**:

- 用户能成功上传配置文件
- 配置解析正确
- 批量添加 MCP 成功
- 导入过程有进度反馈
- 错误处理得当

### 5.2 JSON 配置管理功能

**功能名称**: JSON 配置管理

**业务价值**: 提供灵活的配置方式，适合高级用户和批量操作

**用户故事**: 作为高级用户，我希望能通过编辑 JSON 来配置 MCP

**功能需求**:

- 提供 JSON 编辑区域
- 支持验证、格式化和清除操作
- 解析配置并添加 MCP
- 显示操作结果

**技术实现**:

- 提供 JSON 编辑文本区域
- 实现 JSON 验证和格式化功能
- 解析配置并调用添加接口

**验收标准**:

- 用户能输入和编辑 JSON 配置
- 验证功能能检测无效 JSON
- 格式化功能正常工作
- 配置成功应用
- 有良好的错误反馈

### 5.3 命令行解析功能

**功能名称**: 命令行解析

**业务价值**: 允许用户通过命令行格式快速配置 MCP，适合开发者

**用户故事**: 作为开发者，我希望能从命令行格式直接配置 MCP

**功能需求**:

- 提供命令行输入区域
- 解析命令行格式为配置对象
- 生成对应的 JSON 配置
- 支持引号、参数和环境变量解析

**技术实现**:

- 解析命令行字符串
- 处理引号和特殊字符
- 识别命令、参数和环境变量
- 转换为配置对象

**验收标准**:

- 用户能输入命令行并正确解析
- 支持各种命令格式
- 生成的配置正确
- 解析错误时提供友好提示

## 6. 界面交互领域（UI Interaction Domain）

### 6.1 标签页切换功能

**功能名称**: 标签页切换

**业务价值**: 提供清晰的功能分类，改善用户导航体验

**用户故事**: 作为用户，我希望通过标签页快速切换不同功能

**功能需求**:

- 提供多个功能标签页（MCP 列表、添加 MCP、聊天、函数测试等）
- 点击标签切换相应内容
- 高亮显示当前活动标签
- 保持标签切换的视觉连续性

**技术实现**:

- 标签按钮和内容区域的 DOM 操作
- CSS 类控制显示和高亮

**验收标准**:

- 标签切换平滑无闪烁
- 当前标签正确高亮
- 所有标签内容正确显示

### 6.2 通知提示功能

**功能名称**: 通知提示

**业务价值**: 提供操作反馈，增强用户体验和信任度

**用户故事**: 作为用户，我希望在操作后收到成功或失败的通知

**功能需求**:

- 支持各种操作的成功/失败通知
- 通知应包含相关信息
- 通知应自动消失
- 支持不同类型的通知样式

**技术实现**:

- 通过 toastManager 管理通知
- 定时器控制通知显示和消失
- CSS 动画提升用户体验

**验收标准**:

- 所有主要操作都有适当通知
- 通知信息清晰明了
- 通知显示和消失动画流畅
- 不同类型通知有区分样式

### 6.3 表单验证功能

**功能名称**: 表单验证

**业务价值**: 确保用户输入数据的完整性和正确性，减少错误

**用户故事**: 作为用户，我希望在输入有误时得到提示，防止提交错误数据

**功能需求**:

- 验证必填字段
- 根据 MCP 类型验证相应字段
- 在验证失败时禁用提交按钮
- 提供即时的验证反馈

**技术实现**:

- 输入事件监听和验证
- 表单状态管理
- 按钮启用/禁用控制

**验收标准**:

- 所有必填字段验证正常
- 类型相关字段验证正确
- 验证失败时禁用提交
- 验证状态即时更新

## 7. MCP 服务池领域（MCP Pool Domain）

### 7.1 MCP 实例池化功能

**功能名称**: MCP 实例池化

**业务价值**: 提高资源利用率，避免创建重复的 MCP 服务实例，降低系统负载

**用户故事**: 作为系统运维人员，我希望相同配置的 MCP 服务能够被多个用户会话共享，而不是为每个会话创建独立实例

**功能需求**:

- 根据配置相似度识别可重用的 MCP 实例
- 自动将新会话关联到已存在的匹配实例上
- 维护实例与会话的多对多映射关系
- 提供实例使用情况的统计信息
- 显示实例被多少会话共享

**技术实现**:

- 通过 registry 模块管理所有实例
- 使用 findMatchingInstance 函数查找匹配实例
- 通过 instanceId 唯一标识每个实例
- 使用 associateSessionWithInstance 建立会话与实例的关联

**验收标准**:

- 相同配置的 MCP 服务只创建一个实例
- 多个会话能成功共享同一个实例
- 统计信息正确显示实例的会话数
- 实例复用测试功能正常工作

### 7.2 实例生命周期管理功能

**功能名称**: 实例生命周期管理

**业务价值**: 自动清理闲置资源，避免资源浪费，提高系统稳定性

**用户故事**: 作为系统管理员，我希望系统能自动清理长时间未使用的 MCP 实例，释放资源

**功能需求**:

- 定期检查实例活跃状态
- 识别长时间无活动的实例
- 自动清理无会话关联的空闲实例
- 提供手动触发清理的选项
- 显示上次清理的时间和结果

**技术实现**:

- 使用 lifecycleManager 定期检查实例状态
- 根据配置的 idleTimeout 确定实例是否空闲
- 提供 API 手动触发清理过程
- 记录和显示清理结果

**验收标准**:

- 空闲实例能被自动清理
- 手动清理功能正常工作
- 清理过程不影响活跃实例
- 清理结果有明确反馈
- 池统计信息在清理后更新

### 7.3 服务池监控功能

**功能名称**: 服务池监控

**业务价值**: 提供实例池运行状态的可视化展示，帮助管理员了解系统资源使用情况

**用户故事**: 作为系统管理员，我希望通过直观的界面监控 MCP 服务池的状态和资源使用情况

**功能需求**:

- 显示池中总实例数、活跃实例数和空闲实例数
- 提供实例列表，包含详细信息
- 显示每个实例的状态、类型、会话数等信息
- 支持查看实例详情
- 提供实例删除和操作功能
- 自动或手动刷新监控数据

**技术实现**:

- 通过/api/mcp/pool 接口获取池统计信息
- 通过/api/mcp/instances 接口获取实例列表
- 使用定时器实现自动刷新
- 提供实例详情查看功能

**验收标准**:

- 监控页面正确显示池状态信息
- 实例列表包含所有必要信息
- 自动刷新功能正常工作
- 查看实例详情功能可用
- 删除实例操作有效
- 统计信息与实际情况一致

### 7.4 实例复用测试功能

**功能名称**: 实例复用测试

**业务价值**: 允许开发者验证实例复用机制的有效性，确保系统按预期工作

**用户故事**: 作为开发者，我希望能测试 MCP 实例的复用功能，验证相同配置的实例是否被正确复用

**功能需求**:

- 提供创建重复实例的测试界面
- 允许指定服务名称、命令和参数
- 显示测试结果，包括是否复用已有实例
- 如果复用，显示复用的实例 ID
- 如果创建新实例，显示新实例 ID

**技术实现**:

- 收集测试表单数据
- 调用与添加 MCP 相同的 API
- 解析响应判断是否复用
- 清晰展示测试结果

**验收标准**:

- 用户能通过界面进行实例复用测试
- 相同配置的实例能被正确复用
- 测试结果清晰显示复用状态
- 系统能正确区分应复用和不应复用的情况
- 测试后池状态正确更新

## 非功能性需求

### 性能需求

- 页面加载时间不超过 3 秒
- UI 操作响应时间不超过 500ms
- 支持同时连接至少 10 个 MCP 服务

### 可靠性需求

- 网络连接中断时提供重连机制
- 错误处理机制完善，防止应用崩溃
- 会话恢复成功率不低于 99%

### 安全性需求

- 敏感数据（如 API 密钥）不明文存储
- 会话 ID 使用安全算法生成
- 确保跨站请求伪造(CSRF)防护

### 兼容性需求

- 支持主流浏览器（Chrome、Firefox、Safari、Edge）最新两个版本
- 响应式设计，适应不同屏幕尺寸
- 在网络条件较差时仍能基本工作

### 可用性需求

- 界面直观易用，符合常见 Web 应用交互模式
- 提供足够的操作反馈和提示
- 支持基本的键盘快捷操作
