<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MCP管理界面</title>
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <div class="app-container">
    <header>
      <h1>MCP管理界面</h1>
      <div class="session-info">
        <span id="session-id-display">未连接</span>
        <button id="new-session-btn">新建会话</button>
      </div>
    </header>

    <main>
      <div class="tabs">
        <button class="tab-btn active" data-tab="add-mcp">添加MCP</button>
        <button class="tab-btn" data-tab="list-mcp">已连接MCP <span id="mcp-count">0</span></button>
        <button class="tab-btn" data-tab="chat">聊天</button>
        <button class="tab-btn" data-tab="test-function-call">测试Function Call</button>
        <button class="tab-btn" data-tab="monitor-pool">监控池状态</button>
        <button class="tab-btn" data-tab="python-mcp">Python MCP</button>
        <button class="tab-btn" data-tab="git-mcp">Git MCP</button>
      </div>

      <div class="tab-content active" id="add-mcp">
        <div class="form-container">
          <h2>连接新的MCP服务</h2>

          <div class="quick-add-section">
            <label>快速添加常用MCP服务:</label>
            <select id="preset-mcp-select">
              <option value="">选择预设服务...</option>
              <option value="amap-maps">高德地图 MCP</option>
              <option value="stripe">Stripe MCP</option>
              <option value="openai">OpenAI MCP</option>
              <option value="docker-mcp">Docker MCP</option>
              <option value="python-mcp">Python MCP</option>
            </select>
          </div>

          <div class="divider">或者手动配置</div>

          <div class="command-input-section">
            <div class="divider">或者直接输入命令行</div>
            <div class="form-group">
              <label for="command-line-input">输入MCP启动命令 (例如: npx -y @amap/amap-maps-mcp-server
                --AMAP_MAPS_API_KEY=xxx 或 docker run --rm -p 8080:8080 your-mcp-image)</label>
              <input type="text" id="command-line-input"
                placeholder="npx -y @mcp/server --API_KEY=your-key 或 docker run --rm -p 8080:8080 your-mcp-image">
              <button id="parse-command-btn">解析为配置</button>
            </div>
          </div>

          <div class="config-paste-section">
            <div class="divider">或者直接粘贴配置</div>
            <div class="form-group">
              <label for="config-json">直接输入或粘贴 MCP 配置 (JSON)</label>
              <textarea id="config-json"
                placeholder='{"mcpServers": {"your-server": {"command": "npx", "args": ["-y", "@your/server"], "env": {"API_KEY": "your-key"}}}}'
                rows="10"></textarea>
              <div class="json-actions">
                <button id="validate-json-btn">校验JSON</button>
                <button id="format-json-btn">格式化</button>
                <button id="clear-json-btn">清除</button>
                <button id="parse-config-btn">应用配置</button>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="server-name">名称 *</label>
            <input type="text" id="server-name" placeholder="例如: Stripe" required>
          </div>

          <div class="form-group">
            <label for="server-type">类型 *</label>
            <select id="server-type">
              <option value="stdio">stdio</option>
              <option value="sse">sse</option>
            </select>
          </div>

          <div class="form-group" id="command-group">
            <label for="server-command">命令 *</label>
            <input type="text" id="server-command" placeholder="例如: npx">
          </div>

          <div class="form-group" id="args-group">
            <label for="server-args">参数 (每行一个)</label>
            <textarea id="server-args" placeholder="例如:&#10;-y&#10;@stripe/mcp&#10;--api-key=YOUR_KEY"
              rows="4"></textarea>
          </div>

          <div class="form-group" id="env-group">
            <label for="server-env">环境变量 (每行一个键值对)</label>
            <textarea id="server-env" placeholder="例如:&#10;STRIPE_API_KEY=sk_test_...&#10;STRIPE_ENV=test"
              rows="4"></textarea>
          </div>

          <div class="form-group" id="url-group" style="display: none;">
            <label for="server-url">服务URL *</label>
            <input type="text" id="server-url" placeholder="例如: http://localhost:5000">
          </div>

          <div class="form-actions">
            <button id="add-mcp-btn" disabled>添加MCP</button>
          </div>

          <div class="config-import-section">
            <div class="divider">或者导入配置文件</div>
            <div class="form-group">
              <label for="config-file">导入 MCP 配置文件 (JSON)</label>
              <input type="file" id="config-file" accept=".json">
              <button id="import-config-btn">导入配置</button>
            </div>
          </div>
        </div>
      </div>

      <div class="tab-content" id="list-mcp">
        <div class="mcp-list-container">
          <h2>已连接的MCP服务</h2>
          <div id="mcp-list" class="mcp-list">
            <!-- MCP项目将动态添加到这里 -->
            <div class="empty-state" id="empty-state">
              <p>暂无已连接的MCP</p>
              <button class="add-first-mcp-btn">添加您的第一个MCP服务</button>
            </div>
          </div>
        </div>
      </div>

      <div class="tab-content" id="chat">
        <div class="chat-container">
          <h2>与OpenAI聊天</h2>
          <div class="chat-status">
            <div class="status-label">状态:</div>
            <div id="chat-status" class="status-value">等待连接MCP服务</div>
          </div>

          <div id="chat-messages" class="chat-messages">
            <!-- 聊天消息将动态添加到这里 -->
            <div class="system-message">请连接MCP服务并开始聊天</div>
          </div>

          <div class="chat-input-container">
            <textarea id="chat-input" placeholder="在这里输入消息..." disabled></textarea>
            <button id="send-message-btn" disabled>发送</button>
            <button id="clear-chat-btn">清除聊天</button>
          </div>
        </div>
      </div>

      <div class="tab-content" id="test-function-call">
        <div class="function-test-container">
          <h2>测试OpenAI函数调用</h2>
          <p class="description">使用此界面测试OpenAI的Function Call功能与MCP工具的集成。输入提示OpenAI调用工具的消息，查看结果。</p>

          <div class="function-test-status">
            <div class="status-label">MCP状态:</div>
            <div id="function-test-status" class="status-value">等待连接MCP服务</div>
          </div>

          <div class="function-test-form">
            <div class="form-group">
              <label for="function-test-message">测试消息 (尝试请求使用工具)</label>
              <textarea id="function-test-message" placeholder="例如：'生成一张猫的图片' 或 '翻译 Hello World 到中文'"
                rows="3"></textarea>
            </div>

            <div class="form-actions">
              <button id="run-function-test" disabled>运行测试</button>
              <button id="clear-function-test">清除结果</button>
            </div>
          </div>

          <div class="function-test-results">
            <h3>测试结果:</h3>
            <div id="function-test-output" class="function-test-output">
              <!-- 结果将显示在这里 -->
              <div class="system-message">请连接MCP服务并运行测试</div>
            </div>
          </div>
        </div>
      </div>

      <div class="tab-content" id="monitor-pool">
        <div class="pool-monitor-container">
          <h2>MCP服务池监控</h2>
          <div class="pool-status-section">
            <h3>池状态概览</h3>
            <div class="status-cards">
              <div class="status-card">
                <div class="card-title">总实例数</div>
                <div class="card-value" id="total-instances">-</div>
              </div>
              <div class="status-card">
                <div class="card-title">活跃实例</div>
                <div class="card-value" id="active-instances">-</div>
              </div>
              <div class="status-card">
                <div class="card-title">空闲实例</div>
                <div class="card-value" id="idle-instances">-</div>
              </div>
              <div class="status-card">
                <div class="card-title">最后更新</div>
                <div class="card-value" id="last-update-time">-</div>
              </div>
            </div>
            <div class="actions">
              <button id="refresh-pool-status">刷新状态</button>
              <button id="cleanup-idle-instances">清理空闲实例</button>
            </div>
          </div>

          <div class="instances-section">
            <h3>实例列表</h3>
            <div class="instance-list-header">
              <div class="instance-name">名称</div>
              <div class="instance-id">实例ID</div>
              <div class="instance-type">类型</div>
              <div class="instance-sessions">会话数</div>
              <div class="instance-status">状态</div>
              <div class="instance-created">创建时间</div>
              <div class="instance-actions">操作</div>
            </div>
            <div id="instance-list" class="instance-list">
              <!-- 实例将动态添加到这里 -->
              <div class="empty-state">
                <p>暂无MCP实例</p>
              </div>
            </div>
          </div>

          <div class="reuse-test-section">
            <h3>实例复用测试</h3>
            <div class="test-description">
              <p>此工具可以创建相同配置的MCP实例，用于测试实例复用功能。</p>
            </div>
            <div class="test-form">
              <div class="form-group">
                <label for="test-server-name">服务名称</label>
                <input type="text" id="test-server-name" value="test-mcp" placeholder="例如: test-mcp">
              </div>
              <div class="form-group">
                <label for="test-server-command">命令</label>
                <input type="text" id="test-server-command" value="node" placeholder="例如: node">
              </div>
              <div class="form-group">
                <label for="test-server-args">参数 (逗号分隔)</label>
                <input type="text" id="test-server-args" value="examples/stdio-mcp-server.js"
                  placeholder="例如: index.js">
              </div>
              <div class="test-actions">
                <button id="create-duplicate-instance">创建重复实例</button>
                <div id="reuse-test-result" class="test-result"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="tab-content" id="python-mcp">
        <div class="form-container">
          <h2>创建Python MCP服务器</h2>
          <p class="description">使用此表单可以创建基于Python的MCP服务器，系统将自动安装必要的Python包。</p>

          <div class="form-group">
            <label for="python-server-name">MCP名称 *</label>
            <input type="text" id="python-server-name" placeholder="例如: python-fetch" required value="python-fetch">
          </div>

          <div class="form-group">
            <label for="python-package-name">Python包名称 *</label>
            <input type="text" id="python-package-name" placeholder="例如: mcp-server-fetch" required
              value="mcp-server-fetch">
          </div>

          <div class="form-group">
            <label for="python-module-name">Python模块名称 *</label>
            <input type="text" id="python-module-name" placeholder="例如: mcp_server_fetch" required
              value="mcp_server_fetch">
          </div>

          <div class="form-group">
            <label for="python-extra-args">额外参数 (每行一个)</label>
            <textarea id="python-extra-args" placeholder="例如:&#10;--api-key=YOUR_KEY&#10;--debug=true"
              rows="3"></textarea>
          </div>

          <div class="form-group">
            <label for="python-version">Python命令</label>
            <select id="python-version">
              <option value="python">python</option>
              <option value="python3">python3</option>
              <option value="/opt/homebrew/opt/python@3.13/bin/python3.13">/opt/homebrew/opt/python@3.13/bin/python3.13
              </option>
            </select>
            <input type="text" id="custom-python-path" placeholder="或输入自定义Python路径" style="margin-top: 5px;">
          </div>

          <div class="form-group">
            <label for="pip-command">Pip命令</label>
            <select id="pip-command">
              <option value="pip">pip</option>
              <option value="pip3">pip3</option>
              <option value="python -m pip">python -m pip</option>
              <option value="python3 -m pip">python3 -m pip</option>
              <option value="/opt/homebrew/opt/python@3.13/bin/python3.13 -m pip">homebrew python3.13 -m pip</option>
            </select>
            <input type="text" id="custom-pip-path" placeholder="或输入自定义Pip路径" style="margin-top: 5px;">
          </div>

          <div class="python-config-preview">
            <h3>配置预览</h3>
            <pre id="python-config-preview">
{
  "mcpServers": {
    "python-fetch": {
      "command": "python",
      "args": ["-m", "mcp_server_fetch"],
      "description": "Python MCP服务器",
      "setup": {
        "command": "pip",
        "args": ["install", "mcp-server-fetch"],
        "description": "安装Python包"
      }
    }
  }
}</pre>
          </div>

          <div class="form-actions">
            <button id="create-python-mcp-btn">创建Python MCP服务器</button>
          </div>
        </div>
      </div>

      <div class="tab-content" id="git-mcp">
        <div class="form-container">
          <h2>创建Git仓库MCP服务</h2>
          <p class="description">使用此表单可以从Git仓库创建MCP服务，系统将自动克隆仓库并运行服务。</p>

          <div class="form-group">
            <label for="git-mcp-name">MCP名称 *</label>
            <input type="text" id="git-mcp-name" placeholder="例如: my-git-mcp" required>
          </div>

          <div class="form-group">
            <label for="git-repo-url">Git仓库地址 *</label>
            <input type="text" id="git-repo-url" placeholder="例如: https://github.com/username/repo.git" required>
          </div>

          <div class="form-group">
            <label for="git-repo-token">Git仓库Token (如果是私有仓库)</label>
            <input type="password" id="git-repo-token" placeholder="例如: ghp_xxxxxxxxxxxxxxxx">
          </div>

          <div class="form-group">
            <label for="git-run-script">运行脚本路径 *</label>
            <input type="text" id="git-run-script" placeholder="例如: run.sh 或 scripts/start.js" required value="run.sh">
          </div>

          <div class="form-group">
            <label for="git-script-type">脚本类型</label>
            <select id="git-script-type">
              <option value="shell">Shell脚本</option>
              <option value="node">Node.js脚本</option>
              <option value="python">Python脚本</option>
            </select>
          </div>

          <div class="form-group">
            <label for="git-extra-args">额外参数 (每行一个)</label>
            <textarea id="git-extra-args" placeholder="例如:&#10;--api-key=YOUR_KEY&#10;--debug=true" rows="3"></textarea>
          </div>

          <div class="git-config-preview">
            <h3>配置预览</h3>
            <pre id="git-config-preview">
{
  "mcpServers": {
    "my-git-mcp": {
      "command": "sh",
      "args": ["run.sh"],
      "description": "Git仓库MCP服务",
      "setup": {
        "command": "git",
        "args": ["clone", "https://github.com/username/repo.git", "."],
        "description": "克隆Git仓库"
      }
    }
  }
}</pre>
          </div>

          <div class="form-actions">
            <button id="create-git-mcp-btn">创建Git MCP服务</button>
          </div>
        </div>
      </div>
    </main>

    <div id="toast-container" class="toast-container"></div>
  </div>

  <template id="mcp-item-template">
    <div class="mcp-item">
      <div class="mcp-info">
        <div class="mcp-name"></div>
        <div class="mcp-type"></div>
        <div class="mcp-status"></div>
        <div class="mcp-tools"></div>
      </div>
      <div class="mcp-actions">
        <button class="reconnect-btn" title="重新连接">
          <svg viewBox="0 0 24 24" width="16" height="16">
            <path
              d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 10h7V3l-2.35 3.35z" />
          </svg>
        </button>
        <button class="delete-btn" title="删除">
          <svg viewBox="0 0 24 24" width="16" height="16">
            <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z" />
          </svg>
        </button>
      </div>
    </div>
  </template>

  <template id="chat-message-template">
    <div class="message">
      <div class="message-header">
        <span class="message-sender"></span>
        <span class="message-time"></span>
      </div>
      <div class="message-content"></div>
    </div>
  </template>

  <template id="function-call-template">
    <div class="function-call">
      <h4>函数调用: <span class="function-name"></span></h4>
      <div class="function-section">
        <div class="tool-section-title">参数:</div>
        <pre class="function-params"></pre>
      </div>
      <div class="function-result-container">
        <div class="tool-section-title">结果:</div>
        <pre class="function-result"></pre>
      </div>
    </div>
  </template>

  <template id="instance-item-template">
    <div class="instance-item">
      <div class="instance-name"></div>
      <div class="instance-id"></div>
      <div class="instance-type"></div>
      <div class="instance-sessions"></div>
      <div class="instance-status"></div>
      <div class="instance-created"></div>
      <div class="instance-actions">
        <button class="view-instance-btn">查看</button>
        <button class="remove-instance-btn">删除</button>
      </div>
    </div>
  </template>

  <script src="/socket.io/socket.io.js"></script>
  <script src="app.js"></script>
  <script src="pool-monitor.js"></script>
</body>

</html>